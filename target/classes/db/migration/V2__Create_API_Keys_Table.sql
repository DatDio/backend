-- API_KEYS Table Migration Script for Oracle Database
-- This script creates the API_KEYS table with UPPER_CASE naming convention

-- Create API_KEYS table
CREATE TABLE API_KEYS (
    ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    USER_ID NUMBER(19) NOT NULL,
    KEY_HASH VARCHAR2(255) NOT NULL,
    PERMISSION VARCHAR2(50) DEFAULT 'READ_ONLY' NOT NULL,
    STATUS VARCHAR2(50) DEFAULT 'ACTIVE' NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    EXPIRED_AT TIMESTAMP,
    LAST_USED_AT TIMESTAMP,
    NAME VARCHAR2(100),
    DESCRIPTION VARCHAR2(500),
    CONSTRAINT FK_API_KEYS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    CONSTRAINT CHK_API_KEY_PERMISSION CHECK (PERMISSION IN ('READ_ONLY', 'FULL_ACCESS')),
    CONSTRAINT CHK_API_KEY_STATUS CHECK (STATUS IN ('ACTIVE', 'INACTIVE'))
);

-- Create indexes for better query performance
CREATE INDEX IDX_API_KEY_USER ON API_KEYS(USER_ID);
CREATE INDEX IDX_API_KEY_STATUS ON API_KEYS(STATUS);
CREATE INDEX IDX_API_KEY_CREATED_AT ON API_KEYS(CREATED_AT);
CREATE INDEX IDX_API_KEY_EXPIRED_AT ON API_KEYS(EXPIRED_AT);

-- Add comments to table and columns
COMMENT ON TABLE API_KEYS IS 'Stores hashed API keys for user authentication';
COMMENT ON COLUMN API_KEYS.ID IS 'Primary key (UUID)';
COMMENT ON COLUMN API_KEYS.USER_ID IS 'Foreign key reference to USERS table';
COMMENT ON COLUMN API_KEYS.KEY_HASH IS 'BCrypt hashed API key value (never store plaintext)';
COMMENT ON COLUMN API_KEYS.PERMISSION IS 'API key permission level: READ_ONLY or FULL_ACCESS';
COMMENT ON COLUMN API_KEYS.STATUS IS 'API key status: ACTIVE or INACTIVE';
COMMENT ON COLUMN API_KEYS.CREATED_AT IS 'Timestamp when API key was created';
COMMENT ON COLUMN API_KEYS.UPDATED_AT IS 'Timestamp when API key was last updated';
COMMENT ON COLUMN API_KEYS.EXPIRED_AT IS 'Optional expiration timestamp';
COMMENT ON COLUMN API_KEYS.LAST_USED_AT IS 'Timestamp of last API key usage';
COMMENT ON COLUMN API_KEYS.NAME IS 'Optional friendly name for the API key';
COMMENT ON COLUMN API_KEYS.DESCRIPTION IS 'Optional description of API key purpose';

-- Create trigger to auto-update UPDATED_AT timestamp
CREATE OR REPLACE TRIGGER TRG_API_KEYS_UPDATED_AT
BEFORE UPDATE ON API_KEYS
FOR EACH ROW
BEGIN
    :NEW.UPDATED_AT := CURRENT_TIMESTAMP;
END;
/

-- Grant permissions (adjust as needed for your environment)
-- GRANT SELECT, INSERT, UPDATE, DELETE ON API_KEYS TO your_app_user;

COMMIT;

-- Verification queries
-- SELECT COUNT(*) FROM API_KEYS;
-- SELECT * FROM USER_TAB_COLUMNS WHERE TABLE_NAME = 'API_KEYS';
-- SELECT * FROM USER_INDEXES WHERE TABLE_NAME = 'API_KEYS';
