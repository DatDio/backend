-- Create Wallets Table
CREATE TABLE WALLETS (
    ID NUMBER(19) PRIMARY KEY,
    USER_ID NUMBER(19) NOT NULL UNIQUE,
    BALANCE NUMBER(15,2) DEFAULT 0 NOT NULL,
    TOTAL_DEPOSITED NUMBER(15,2) DEFAULT 0,
    TOTAL_SPENT NUMBER(15,2) DEFAULT 0,
    IS_LOCKED NUMBER(1) DEFAULT 0 NOT NULL,
    LOCK_REASON VARCHAR2(500),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY VARCHAR2(255),
    UPDATED_BY VARCHAR2(255),
    CONSTRAINT FK_WALLET_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

-- Create sequence for Wallets
CREATE SEQUENCE WALLETS_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Create Transactions Table
CREATE TABLE TRANSACTIONS (
    ID NUMBER(19) PRIMARY KEY,
    TRANSACTION_CODE VARCHAR2(50) NOT NULL UNIQUE,
    USER_ID NUMBER(19) NOT NULL,
    WALLET_ID NUMBER(19) NOT NULL,
    TYPE VARCHAR2(50) NOT NULL,
    AMOUNT NUMBER(15,2) NOT NULL,
    BALANCE_BEFORE NUMBER(15,2),
    BALANCE_AFTER NUMBER(15,2),
    STATUS VARCHAR2(50) DEFAULT 'PENDING' NOT NULL,
    DESCRIPTION VARCHAR2(1000),
    PAYMENT_METHOD VARCHAR2(50),
    PAYMENT_REFERENCE VARCHAR2(255),
    PAYOS_ORDER_CODE NUMBER(19),
    IP_ADDRESS VARCHAR2(45),
    USER_AGENT VARCHAR2(500),
    COMPLETED_AT TIMESTAMP,
    ERROR_MESSAGE VARCHAR2(1000),
    ORDER_ID NUMBER(19),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY VARCHAR2(255),
    UPDATED_BY VARCHAR2(255),
    CONSTRAINT FK_TRANSACTION_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_TRANSACTION_WALLET FOREIGN KEY (WALLET_ID) REFERENCES WALLETS(ID),
    CONSTRAINT FK_TRANSACTION_ORDER FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID)
);

-- Create sequence for Transactions
CREATE SEQUENCE TRANSACTIONS_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Create indexes for performance and security checks
CREATE INDEX IDX_WALLET_USER ON WALLETS(USER_ID);
CREATE INDEX IDX_WALLET_LOCKED ON WALLETS(IS_LOCKED);

CREATE INDEX IDX_TRANSACTION_CODE ON TRANSACTIONS(TRANSACTION_CODE);
CREATE INDEX IDX_TRANSACTION_USER ON TRANSACTIONS(USER_ID);
CREATE INDEX IDX_TRANSACTION_WALLET ON TRANSACTIONS(WALLET_ID);
CREATE INDEX IDX_TRANSACTION_STATUS ON TRANSACTIONS(STATUS);
CREATE INDEX IDX_TRANSACTION_TYPE ON TRANSACTIONS(TYPE);
CREATE INDEX IDX_TRANSACTION_PAYOS ON TRANSACTIONS(PAYOS_ORDER_CODE);
CREATE INDEX IDX_TRANSACTION_CREATED ON TRANSACTIONS(CREATED_AT);

-- Index for DDoS protection (IP rate limiting)
CREATE INDEX IDX_TRANSACTION_IP_TIME ON TRANSACTIONS(IP_ADDRESS, CREATED_AT);

-- Index for duplicate detection
CREATE INDEX IDX_TRANSACTION_USER_AMOUNT ON TRANSACTIONS(USER_ID, AMOUNT, STATUS, CREATED_AT);

-- Index for pending transaction check
CREATE INDEX IDX_TRANSACTION_PENDING ON TRANSACTIONS(USER_ID, STATUS, CREATED_AT);

-- Add comments
COMMENT ON TABLE WALLETS IS 'User wallets - stores user balance';
COMMENT ON TABLE TRANSACTIONS IS 'Transaction history - all wallet transactions';
COMMENT ON COLUMN TRANSACTIONS.TYPE IS 'Transaction type: DEPOSIT, PURCHASE, REFUND, ADMIN_ADJUST';
COMMENT ON COLUMN TRANSACTIONS.STATUS IS 'Transaction status: PENDING, PROCESSING, SUCCESS, FAILED, CANCELLED, REFUNDED';
COMMENT ON COLUMN TRANSACTIONS.PAYOS_ORDER_CODE IS 'PayOS order code for payment tracking';
COMMENT ON COLUMN TRANSACTIONS.IP_ADDRESS IS 'Client IP for security and fraud detection';

-- Trigger to automatically create wallet when user is created
CREATE OR REPLACE TRIGGER TRG_CREATE_WALLET_FOR_USER
AFTER INSERT ON USERS
FOR EACH ROW
BEGIN
    INSERT INTO WALLETS (
        ID,
        USER_ID,
        BALANCE,
        TOTAL_DEPOSITED,
        TOTAL_SPENT,
        IS_LOCKED,
        CREATED_AT,
        UPDATED_AT
    ) VALUES (
        WALLETS_SEQ.NEXTVAL,
        :NEW.ID,
        0,
        0,
        0,
        0,
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP
    );
END;
/
