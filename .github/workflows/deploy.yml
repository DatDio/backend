name: Backend CI/CD

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 1: TRIGGER - Khi nÃ o workflow cháº¡y?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  push:
    branches: [master]        # Cháº¡y khi push vÃ o branch master
  pull_request:
    branches: [master]        # Cháº¡y khi táº¡o PR vÃ o master (chá»‰ build, ko deploy)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 2: JOBS - CÃ¡c cÃ´ng viá»‡c cáº§n thá»±c hiá»‡n
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: BUILD - Cháº¡y trÃªn GitHub Runner (mÃ¡y áº£o Ubuntu cá»§a GitHub)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest    # Sá»­ dá»¥ng mÃ¡y áº£o Ubuntu má»›i nháº¥t cá»§a GitHub (miá»…n phÃ­)

    steps:
      # BÆ°á»›c 1: Clone code tá»« repo vá» mÃ¡y áº£o GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # BÆ°á»›c 2: CÃ i Ä‘áº·t Java 21 (Temurin distribution)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'           # Version Java
          distribution: 'temurin'      # Báº£n phÃ¢n phá»‘i Eclipse Temurin
          cache: maven                 # Cache Maven dependencies Ä‘á»ƒ láº§n sau build nhanh hÆ¡n

      # BÆ°á»›c 3: Build project vá»›i Maven
      - name: Build with Maven
        run: mvn clean package -DskipTests    # Build JAR file, bá» qua test Ä‘á»ƒ nhanh

      # BÆ°á»›c 4: Cháº¡y unit tests
      - name: Run tests
        run: mvn test
        continue-on-error: true        # Náº¿u test fail váº«n tiáº¿p tá»¥c workflow

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: DEPLOY - SSH vÃ o VPS vÃ  deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: build                       # âš ï¸ Pháº£i Ä‘á»£i job "build" hoÃ n thÃ nh trÆ°á»›c
    
    # Äiá»u kiá»‡n: Chá»‰ deploy khi PUSH vÃ o master (khÃ´ng deploy khi táº¡o PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      # SSH vÃ o VPS vÃ  cháº¡y cÃ¡c lá»‡nh deploy
      - name: Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.3   # Action SSH phá»• biáº¿n nháº¥t
        with:
          # ThÃ´ng tin káº¿t ná»‘i VPS (láº¥y tá»« GitHub Secrets)
          host: ${{ secrets.VPS_HOST }}         # IP hoáº·c domain VPS
          username: ${{ secrets.VPS_USERNAME }} # Username SSH (vd: ubuntu, root)
          key: ${{ secrets.VPS_SSH_KEY }}       # Private key SSH
          port: ${{ secrets.VPS_PORT }}         # Port SSH (thÆ°á»ng lÃ  22)
          
          # Script cháº¡y trÃªn VPS
          script: |
            set -e  # Dá»«ng ngay náº¿u cÃ³ lá»—i
            
            echo "ğŸ“ Navigating to project..."
            cd ${{ secrets.PROJECT_PATH }}      # VÃ o /opt/mailshop
            
            echo "ğŸ“¥ Pulling latest backend code..."
            cd backend                          # VÃ o folder backend
            git fetch --all                     # Fetch táº¥t cáº£ changes tá»« remote
            git reset --hard origin/master      # Reset vá» commit má»›i nháº¥t cá»§a origin/master
            cd ..                               # Quay láº¡i /opt/mailshop
            
            echo "ğŸ”„ Rebuilding backend container..."
            docker compose stop backend                   # Dá»«ng container cÅ©
            docker compose build --no-cache backend       # Build láº¡i image (khÃ´ng dÃ¹ng cache)
            docker compose up -d backend                  # Cháº¡y container má»›i á»Ÿ background
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f               # XÃ³a images cÅ© khÃ´ng dÃ¹ng
            
            echo "ğŸ“Š Container status:"
            docker compose ps backend           # Hiá»ƒn thá»‹ tráº¡ng thÃ¡i container
            
            echo "âœ… Backend deployed successfully!"
